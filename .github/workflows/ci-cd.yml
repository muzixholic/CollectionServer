     name: CI/CD Pipeline

     on:
       push:
         branches: [ "main" ]
       pull_request:
         branches: [ "main" ]

     env:
       REGISTRY: ghcr.io
       IMAGE_NAME: ${{ github.repository }}

     jobs:
       build-and-test:
         runs-on: ubuntu-latest
         permissions:
           contents: read
           packages: write

         steps:
         - uses: actions/checkout@v4

         - name: Setup .NET
           uses: actions/setup-dotnet@v4
           with:
             dotnet-version: 10.0.x

         - name: Restore dependencies
           run: dotnet restore

         - name: Build
           run: dotnet build --no-restore --configuration Release

         - name: Test
             run: |
               dotnet test tests/CollectionServer.UnitTests --no-build --configuration Release --verbosity norma
               dotnet test tests/CollectionServer.IntegrationTests --no-build --configuration Release --verbosity
   normal
               dotnet test tests/CollectionServer.ContractTests --no-build --configuration Release --verbosity normal


         - name: Log in to the Container registry
           if: github.event_name != 'pull_request'
           uses: docker/login-action@v3
           with:
             registry: ${{ env.REGISTRY }}
             username: ${{ github.actor }}
             password: ${{ secrets.GITHUB_TOKEN }}

         - name: Extract metadata (tags, labels) for Docker
           if: github.event_name != 'pull_request'
           id: meta
           uses: docker/metadata-action@v5
           with:
             images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
             tags: |
               type=raw,value=latest,enable={{is_default_branch}}
               type=sha,format=short

         - name: Build and push Docker image
           if: github.event_name != 'pull_request'
           uses: docker/build-push-action@v5
           with:
             context: .
             file: Containerfile
             push: true
             tags: ${{ steps.meta.outputs.tags }}
             labels: ${{ steps.meta.outputs.labels }}
